<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<style>
body { margin: 0; padding: 0; font: 12px sans-serif; }
path, line { shape-rendering: crispEdges; }
svg { pointer-events: none; }
.axis path, .axis line { fill: none; stroke: #000; stroke-width: 1px; }
circle { stroke-width: 4px; stroke: #000; fill: none; }
.hidden { display: none; }
#sidebar strong {float: left;}
</style>
<link href="https://unpkg.com/basscss@8.0.2/css/basscss.min.css" rel="stylesheet">
</head>
<body>
<div class="clearfix">
  <div id="sidebar" class="col sm-col-12 left">
    <h3>Selected Feature Info:</h3>
    <strong>sample: </strong><p id="sample_id">NA</p>
    <strong>mz: </strong><p id="mz">NA</p>
    <strong>retention time: </strong><p id="rt">NA</p>
    <strong>poloarity:	</strong><p id="polarity">NA</p>
    <strong>predictions:	</strong><p id="predictions">NA</p>
  </div>
  <div id="chart" class="col sm-col-12 left" style="height: 500px;"></div>
</div>
<script src="d3.min.js"></script>

<script>

var chartDiv = document.getElementById("chart");

var margin = {top: 20, right: 10, bottom: 30, left: 40};

function draw() {
  var width = chartDiv.clientWidth;
  var height = chartDiv.clientHeight;
  console.log(width, height)

  var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("float", "left")
    .attr("position", "absolute")
    .append("g")
      .attr("transform", "translate(" + margin.left + " " + margin.top + ")");

  var x = d3.scaleLinear()
    .range([0, width]);

  var y = d3.scaleLinear()
    .range([height, 0]);

  var xg = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")");

  var yg = svg.append("g")
    .attr("class", "y axis");

  var chartArea = d3.select("#chart").append("div")
    .style("margin-left", margin.left + "px")
    .style("margin-top", margin.top + "px")
    .style("float", "left")
    .style("position", "absolute");

  var canvas = chartArea.append("canvas")
    .attr("width", width)
    .attr("height", height)
    .style("position", "absolute");

  var offscreen = d3.select(document.createElement("canvas"))
    .attr("width", width)
    .attr("height", height)

  var context = canvas.node().getContext("2d"),
      picker = offscreen.node().getContext("2d");

  context.fillStyle = "#f0f";

  // Layer on top of canvas, example of selection details
  var highlight = chartArea.append("svg")
    .attr("width", width)
    .attr("height", height)
      .append("circle")
        .classed("hidden", true);

  d3.tsv("d3-test-data.tsv").then(function(data) {

    data.forEach(function(d) {
      d.oc = +d.oc
      d.hc = +d.hc
      d.size = Math.sqrt(d.size/Math.PI) // absolute scaling
      d.color = +d.color
    });

    // Redraw axes
    x.domain([0, d3.max(data, d => d.oc)]);
    y.domain([0, d3.max(data, d => d.hc)]);
    xg.call(d3.axisBottom(x));
    yg.call(d3.axisLeft(y)); 

    var colors = {};

    // Update canvas
    context.clearRect(0, 0, width, height);
    picker.clearRect(0, 0, width, height);

    data.forEach(function(p,i){
      // Space out the colors a bit
      var color = getColor(i * 1000 + 1);
      colors[color] = p;
      picker.fillStyle = "rgb(" + color + ")";

      context.fillStyle = d3.interpolateViridis(p.color);

      context.beginPath();
      picker.beginPath();

      context.arc(x(p.oc), y(p.hc), p.size, 0, 2 * Math.PI);
      picker.arc(x(p.oc), y(p.hc), p.size, 0, 2 * Math.PI);

      context.fill();
      picker.fill();
    });

    canvas.on("mousemove",function(){
      var xy = d3.mouse(this);

      // Get pixel from offscreen canvas
      var color = picker.getImageData(xy[0], xy[1], 1, 1).data;
          selected = colors[color.slice(0,3).toString()];

      highlight.classed("hidden", !selected);

      // If it matches a point, highlight it
      if (selected) {
        console.log(selected);
        highlight.attr("cx", x(selected.oc))
          .attr("cy", y(selected.hc))
          .attr("r", selected.size);
      }
    });

    canvas.on("click",function(){
      if (selected) {
	document.getElementById("sample_id").innerHTML = selected.sample_id;
	document.getElementById("mz").innerHTML = selected.mz;
	document.getElementById("rt").innerHTML = selected.rt;
	document.getElementById("polarity").innerHTML = selected.polarity;
	document.getElementById("predictions").innerHTML = selected.predictions;
      }
    });

  });
  console.log("foo resize")
};

function getColor(i) {
  return (i % 256) + "," + (Math.floor(i / 256) % 256) + "," + (Math.floor(i / 65536) % 256);
}

// inital draw
draw(); 

function redraw() {
  d3.select("#chart svg").remove();
  d3.select("#chart div").remove();
  draw();
}

// redraw on browser window resize
window.addEventListener("resize", redraw);

</script>
</body>
</html>
