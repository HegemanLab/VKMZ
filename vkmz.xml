<tool id="vkmz" name="vkmz" version="alpha-0.1">

  <description>predict formulas and generate VK diagram</description>
  
  <requirements>
    <requirement type="package" version="2.7">python</requirement>
    <requirement type="package">pandas</requirement>
    <requirement type="package">plotly</requirement>
  </requirements>
  
  <stdio>
    <exit_code range="1:" level="fatal" />
  </stdio>

  <command detect_errors="aggressive"><![CDATA[
    #if str( $mode.mode_selector ) == "xcms":
      python $__tool_directory__/vkmz.py
        xcms
	--data-matrix $mode.datamatrix
	--sample-metadata $mode.samplemetadata
	--variable-metadata $mode.variablemetadata
        --error $mode.error
	--database $mode.database
        --output vkmz
	--size $mode.size
	--size-algorithm $mode.sizealgorithm
        --directory $__tool_directory__/
    #elif str( $mode.mode_selector ) == "tsv":
      python $__tool_directory__/vkmz.py
        tsv
	--input $mode.input
        --error $mode.error
	--database $mode.database
        --output vkmz
	--size $mode.size
	--size-algorithm $mode.sizealgorithm
        --directory $__tool_directory__/
    #end if
  ]]></command>

  <inputs>
    <conditional name="mode">
      <param name="mode_selector" type="select" label="Select vkmz mode:">
        <option value="xcms">xcms</option>
        <option value="tsv">tsv</option>
        <option value="plot">plot</option>
      </param>
      <when value="xcms">
        <param name="datamatrix" label="XCMS Data Matrix" type="data" format="tabular" help="Select XCMS data matrix." />
        <param name="samplemetadata" label="XCMS Sample Metadata" type="data" format="tabular" help="Select XCMS sample metadata" />
        <param name="variablemetadata" label="XCMS Variable Metadata" type="data" format="tabular" help="Select XCMS variable metadata." />
        <param name="error" label="PPM Error" type="integer" value="5" min="0" help="Parts per million mass error. Set according to mass spectrometer." />
        <param name="database" label="Database" type="select" help="Choose database of known formula masses.">
          <option value="databases/bmrb-light.tsv">Monoisotopic</option>
          <option value="databases/bmrb-heavy_carbon.tsv">C13 Labeled</option>
          <option value="databases/bmrb-heavy_nitrogen.tsv">N15 Labeled</option>
          <option value="databases/bmrb-heavy.tsv">C13 and C15 Labeled</option>
        </param>
        <param name="size" label="Marker base size" type="integer" value="5" min="0" help="Base size of marker." />
        <param name="sizealgorithm" label="Marker size algorithm" type="select" help="Algorithm to determine size. Option 1 size of marker. Option 2 determines size based on feature intensity.">
          <option value="0">Uniform Size</option>
          <option value="1">Other</option>
        </param>
      </when>
      <when value="tsv">
        <param name="input" label="Tabular input" type="data" format="tabular" help="Select tabular input." />
        <param name="error" label="PPM Error" type="integer" value="5" min="0" help="Parts per million mass error. Set according to mass spectrometer." />
        <param name="database" label="Database" type="select" help="Choose database of known formula masses.">
          <option value="databases/bmrb-light.tsv">Monoisotopic</option>
          <option value="databases/bmrb-heavy_carbon.tsv">C13 Labeled</option>
          <option value="databases/bmrb-heavy_nitrogen.tsv">N15 Labeled</option>
          <option value="databases/bmrb-heavy.tsv">C13 and C15 Labeled</option>
        </param>
        <param name="size" label="Marker base size" type="integer" value="5" min="0" help="Base size of marker." />
        <param name="sizealgorithm" label="Marker size algorithm" type="select" help="Algorithm to determine size. Option 1 size of marker. Option 2 determines size based on feature intensity.">
          <option value="0">Uniform Size</option>
          <option value="1">Other</option>
        </param>
      </when>
      <when value="do_not_set">
        <!-- do nothing -->
      </when>
    </conditional>
  </inputs>

  <outputs>
    #if str( $mode.mode_selector ) == "xcms" or "tsv":
      <data format="tabular" name="output" from_work_dir="vkmz.tsv" label="${tool.name}">
        <filter>(mode["mode_selector"] == "xcms" or "tsv")</filter>
      </data>
    #end if
  </outputs>

  <tests>
    <test>
      <conditional name="mode">
        <param name="mode_selector" value="xcms" />
        <param name="datamatrix" value="datamatrix.tabular" />
        <param name="samplemetadata" value="sampleMetadata.tabular" />
        <param name="variablemetadata" value="variableMetadata.tabular" />
        <param name="error" value="3" />
        <param name="database" value="databases/bmrb-light.tsv" />
      </conditional>
      <output name="output">
        <assert_contents>
          <has_text text="9.366969197799335e-05" />
        </assert_contents>
      </output>
    </test>
    <test>
      <conditional name="mode">
        <param name="mode_selector" value="tsv" />
        <param name="input" value="tabular.tabular" />
        <param name="error" value="3" />
        <param name="database" value="databases/bmrb-light.tsv" />
      </conditional>
      <output name="output">
        <assert_contents>
          <has_text text="9.36699999556e-05" />
        </assert_contents>
      </output>
    </test>
  </tests>

  <help><![CDATA[

**Authors** - Mark Esler (eslerm@umn.edu)
**Authors** - Stephen Brockman (brock197@umn.edu)

Release notes
-------------

Version 0.9

  ]]></help>

  <citations>
    <!--Van Krevelen diagram visualization of high resolution-mass spectrometry metabolomics data with OpenVanKrevelen-->
    <citation type="doi">10.1007/s11306-018-1343-y</citation>
  </citations>

</tool>
